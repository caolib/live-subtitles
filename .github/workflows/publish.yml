name: 发布应用

on:
    push:
        tags:
            - "[0-9]+.[0-9]+.[0-9]+"

jobs:
    publish-tauri:
        permissions:
            contents: write
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: "windows-latest"
                      args: "--target x86_64-pc-windows-msvc"

        runs-on: ${{ matrix.platform }}
        steps:
            - name: 检出代码
              uses: actions/checkout@v4

            - name: 安装 pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 9

            - name: 设置 Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: lts/*
                  cache: "pnpm"

            - name: 安装 Rust 稳定版
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: x86_64-pc-windows-msvc

            - name: 缓存 Rust 依赖
              uses: Swatinem/rust-cache@v2
              with:
                  workspaces: "./src-tauri -> target"

            - name: 安装前端依赖
              run: pnpm install

            - name: 构建并发布应用
              uses: tauri-apps/tauri-action@v0.5
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
                  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
              with:
                  tagName: ${{ github.ref_name }}
                  releaseName: "Live Subtitles v${{ github.ref_name }}"
                  releaseBody: |
                      查看完整更新日志，请访问 [RELEASE.md](https://github.com/caolib/live-subtitles/blob/${{ github.ref_name }}/docs/RELEASE.md)

                      ## 安装说明

                      ### Windows
                      下载并运行 `.msi` 或 `.exe` 安装包。

                      ### 自动更新
                      应用程序支持一键更新，打开"关于"对话框检查新版本并点击"立即更新"按钮。

                      ---

                      ⚠️ **重要**: 首次使用请下载对应的语音识别模型文件，详见 [README](https://github.com/caolib/live-subtitles#模型下载)
                  releaseDraft: false
                  prerelease: false
                  args: ${{ matrix.args }}
